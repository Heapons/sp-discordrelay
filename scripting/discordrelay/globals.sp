#define ALICE_BLUE "F0F8FF"
#define ALLIES "4D7942" // same as Allies team in DoD:S
#define ANCIENT "EB4B4B" // same as Ancient item rarity in Dota 2
#define ANTIQUE_WHITE "FAEBD7"
#define AQUA "00FFFF"
#define AQUAMARINE "7FFFD4"
#define ARCANA "ADE55C" // same as Arcana item rarity in Dota 2
#define AXIS "FF4040" // same as Axis team in DoD:S
#define AZURE "007FFF"
#define BEIGE "F5F5DC"
#define BISQUE "FFE4C4"
#define BLACK "000000"
#define BLANCHED_ALMOND "FFEBCD"
#define BLUE "99CCFF" // same as BLU/Counter-Terrorist team color
#define BLUE_VIOLET "8A2BE2"
#define BROWN "A52A2A"
#define BURLYWOOD "DEB887"
#define CADET_BLUE "5F9EA0"
#define CHARTREUSE "7FFF00"
#define CHOCOLATE "D2691E"
#define COLLECTORS "AA0000" // same as Collector's item quality in TF2
#define COMMON "B0C3D9" // same as Common item rarity in Dota 2
#define COMMUNITY "70B04A" // same as Community item quality in TF2
#define CORAL "FF7F50"
#define CORNFLOWER_BLUE "6495ED"
#define CORNSILK "FFF8DC"
#define CORRUPTED "A32C2E" // same as Corrupted item quality in Dota 2
#define CRIMSON "DC143C"
#define CYAN "00FFFF"
#define DARK_BLUE "00008B"
#define DARK_CYAN "008B8B"
#define DARK_GOLDENROD "B8860B"
#define DARK_GRAY "A9A9A9"
#define DARK_GREY "A9A9A9"
#define DARK_GREEN "006400"
#define DARK_KHAKI "BDB76B"
#define DARK_MAGENTA "8B008B"
#define DARK_OLIVE_GREEN "556B2F"
#define DARK_ORANGE "FF8C00"
#define DARK_ORCHID "9932CC"
#define DARK_RED "8B0000"
#define DARK_SALMON "E9967A"
#define DARK_SEA_GREEN "8FBC8F"
#define DARK_SLATE_BLUE "483D8B"
#define DARK_SLATE_GRAY "2F4F4F"
#define DARK_SLATE_GREY "2F4F4F"
#define DARK_TURQUOISE "00CED1"
#define DARK_VIOLET "9400D3"
#define DEEP_PINK "FF1493"
#define DEEP_SKY_BLUE "00BFFF"
#define DIM_GRAY "696969"
#define DIM_GREY "696969"
#define DODGER_BLUE "1E90FF"
#define EXALTED "CCCCCD" // same as Exalted item quality in Dota 2
#define FIREBRICK "B22222"
#define FLORAL_WHITE "FFFAF0"
#define FOREST_GREEN "228B22"
#define FROZEN "4983B3" // same as Frozen item quality in Dota 2
#define FUCHSIA "FF00FF"
#define FULL_BLUE "0000FF"
#define FULL_RED "FF0000"
#define GAINSBORO "DCDCDC"
#define GENUINE "4D7455" // same as Genuine item quality in TF2
#define GHOST_WHITE "F8F8FF"
#define GOLD "FFD700"
#define GOLDENROD "DAA520"
#define GRAY "CCCCCC" // same as spectator team color
#define GREY "CCCCCC"
#define GREEN "3EFF3E"
#define GREEN_YELLOW "ADFF2F"
#define HAUNTED "38F3AB" // same as Haunted item quality in TF2
#define HONEYDEW "F0FFF0"
#define HOT_PINK "FF69B4"
#define IMMORTAL "E4AE33" // same as Immortal item rarity in Dota 2
#define INDIAN_RED "CD5C5C"
#define INDIGO "4B0082"
#define IVORY "FFFFF0"
#define KHAKI "F0E68C"
#define LAVENDER "E6E6FA"
#define LAVENDER_BLUSH "FFF0F5"
#define LAWN_GREEN "7CFC00"
#define LEGENDARY "D32CE6" // same as Legendary item rarity in Dota 2
#define LEMON_CHIFFON "FFFACD"
#define LIGHT_BLUE "ADD8E6"
#define LIGHT_CORAL "F08080"
#define LIGHT_CYAN "E0FFFF"
#define LIGHT_GOLDENROD_YELLOW "FAFAD2"
#define LIGHT_GRAY "D3D3D3"
#define LIGHT_GREY "D3D3D3"
#define LIGHT_GREEN "99FF99"
#define LIGHT_PINK "FFB6C1"
#define LIGHT_SALMON "FFA07A"
#define LIGHT_SEA_GREEN "20B2AA"
#define LIGHT_SKY_BLUE "87CEFA"
#define LIGHT_SLATE_GRAY "778899"
#define LIGHT_SLATE_GREY "778899"
#define LIGHT_STEEL_BLUE "B0C4DE"
#define LIGHT_YELLOW "FFFFE0"
#define LIME "00FF00"
#define LIME_GREEN "32CD32"
#define LINEN "FAF0E6"
#define MAGENTA "FF00FF"
#define MAROON "800000"
#define MEDIUM_AQUAMARINE "66CDAA"
#define MEDIUM_BLUE "0000CD"
#define MEDIUM_ORCHID "BA55D3"
#define MEDIUM_PURPLE "9370D8"
#define MEDIUM_SEA_GREEN "3CB371"
#define MEDIUM_SLATE_BLUE "7B68EE"
#define MEDIUM_SPRING_GREEN "00FA9A"
#define MEDIUM_TURQUOISE "48D1CC"
#define MEDIUM_VIOLET_RED "C71585"
#define MIDNIGHT_BLUE "191970"
#define MINT_CREAM "F5FFFA"
#define MISTY_ROSE "FFE4E1"
#define MOCCASIN "FFE4B5"
#define MYTHICAL "8847FF" // same as Mythical item rarity in Dota 2
#define NAVAJO_WHITE "FFDEAD"
#define NAVY "000080"
#define NORMAL "B2B2B2" // same as Normal item quality in TF2
#define OLD_LACE "FDF5E6"
#define OLIVE "9EC34F"
#define OLIVE_DRAB "6B8E23"
#define ORANGE "FFA500"
#define ORANGE_RED "FF4500"
#define ORCHID "DA70D6"
#define PALE_GOLDENROD "EEE8AA"
#define PALE_GREEN "98FB98"
#define PALE_TURQUOISE "AFEEEE"
#define PALE_VIOLET_RED "D87093"
#define PAPAYA_WHIP "FFEFD5"
#define PEACH_PUFF "FFDAB9"
#define PERU "CD853F"
#define PINK "FFC0CB"
#define PLUM "DDA0DD"
#define POWDER_BLUE "B0E0E6"
#define PURPLE "800080"
#define RARE "4B69FF" // same as Rare item rarity in Dota 2
#define RED "FF4040" // same as RED/Terrorist team color
#define ROSY_BROWN "BC8F8F"
#define ROYAL_BLUE "4169E1"
#define SADDLE_BROWN "8B4513"
#define SALMON "FA8072"
#define SANDY_BROWN "F4A460"
#define SEA_GREEN "2E8B57"
#define SEASHELL "FFF5EE"
#define SELF_MADE "70B04A" // same as Self-Made item quality in TF2
#define SIENNA "A0522D"
#define SILVER "C0C0C0"
#define SKY_BLUE "87CEEB"
#define SLATE_BLUE "6A5ACD"
#define SLATE_GRAY "708090"
#define SLATE_GREY "708090"
#define SNOW "FFFAFA"
#define SPRING_GREEN "00FF7F"
#define STEEL_BLUE "4682B4"
#define STRANGE "CF6A32" // same as Strange item quality in TF2
#define TAN "D2B48C"
#define TEAL "008080"
#define THISTLE "D8BFD8"
#define TOMATO "FF6347"
#define TURQUOISE "40E0D0"
#define UNCOMMON "B0C3D9" // same as Uncommon item rarity in Dota 2
#define UNIQUE "FFD700" // same as Unique item quality in TF2
#define UNUSUAL "8650AC" // same as Unusual item quality in TF2
#define VALVE "A50F79" // same as Valve item quality in TF2
#define VINTAGE "476291" // same as Vintage item quality in TF2
#define VIOLET "EE82EE"
#define WHEAT "F5DEB3"
#define WHITE "FFFFFF"
#define WHITE_SMOKE "F5F5F5"
#define YELLOW "FFFF00"
#define YELLOW_GREEN "9ACD32"

DiscordBot g_Bot;
bool g_Late;
bool g_ChatAnnounced;
bool g_RCONAnnounced;

enum struct Player
{
    char SteamID2[32];
    char SteamID64[32];
    int UserID;
    char AvatarURL[256];
    int retries;

    void Load(int client)
    {
        this.UserID = GetClientUserId(client);
        GetSteamID(this.UserID);
    }
}

Player g_Players[1000];

void GetSteamID(int userid)
{
    int client = GetClientOfUserId(userid);
    if (GetClientAuthId(client, AuthId_Steam2, g_Players[userid].SteamID2, sizeof(Player::SteamID2)) &&
        GetClientAuthId(client, AuthId_SteamID64, g_Players[userid].SteamID64, sizeof(Player::SteamID64)))
    {
        if (g_cvServerToDiscordAvatars.BoolValue)
        {
            SteamAPIRequest(userid);
        }
        else
        {
            if (g_cvConnectMessage.BoolValue)
            {
                PrintToDiscord(userid, MEDIUM_SEA_GREEN, "connected");
            }
        }
    }
    else
    {
        CreateTimer(60.0, RetrySteamIDRetrieval, userid);
    }
}

Action RetrySteamIDRetrieval(Handle timer, int userid)
{
    int client = GetClientOfUserId(userid);
    g_Players[userid].retries++;
    LogMessage("Retrying Steam ID for %N... (%i) attempts.", client, g_Players[userid].retries);
    if (g_Players[userid].retries > 10)
    {
        LogError("Could not retrieve %N's Steam ID after 10 attempts.", client);
        return Plugin_Stop;
    }

    GetSteamID(userid);
    return Plugin_Continue;
}

stock void SteamAPIRequest(int userid)
{
    HTTPRequest req = new HTTPRequest("http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v2");
    req.AppendQueryParam("steamids", g_Players[userid].SteamID64);
    req.AppendQueryParam("key", g_sSteamApiKey);
    req.Get(SteamResponse_Callback, userid);
}

stock void SteamResponse_Callback(HTTPResponse response, int userid)
{
    if (response.Status != HTTPStatus_OK)
    {
        LogError("SteamAPI request fail, HTTPSResponse code %i", response.Status);
        if (g_cvConnectMessage.BoolValue)
        {
            PrintToDiscord(userid, MEDIUM_SEA_GREEN, "connected");
        }
        return;
    }

    JSONObject objects = view_as<JSONObject>(response.Data);
    JSONObject Response = view_as<JSONObject>(objects.Get("response"));
    JSONArray jsonPlayers = view_as<JSONArray>(Response.Get("players"));
    int playerlen = jsonPlayers.Length;
    JSONObject player;
    for (int i = 0; i < playerlen; i++)
    {
        player = view_as<JSONObject>(jsonPlayers.Get(i));
        player.GetString("avatarmedium", g_Players[userid].AvatarURL, sizeof(Player::AvatarURL));
        delete player;
    }
    
    if (g_cvConnectMessage.BoolValue)
    {
        PrintToDiscord(userid, MEDIUM_SEA_GREEN, "connected");
    }
}